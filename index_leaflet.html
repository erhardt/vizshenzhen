<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>IN THE MIX</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="libs/css/leaflet.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400,300,700' rel='stylesheet' type='text/css'>

<!--[if lte IE 8]><link rel="stylesheet" href="libs/css/leaflet.ie.css" /><![endif]-->

<style>
#map {
	width: 100%;
	height: 100%;
	position: absolute;
	top: 0;
	left: 0;
}

.leaflet-container, text {
    font: 15px "Open Sans","Gill Sans","Helvetica Neue","Helvetica","Arial",sans-serif;
    font-weight: lighter;
    color: #fff;
}

.leaflet-top .leaflet-control, 
.leaflet-right .leaflet-control, 
.leaflet-bottom .leaflet-control, 
.leaflet-left .leaflet-control {
	margin: 0;
	box-shadow: 0 0 15px rgba(255,255,255,0.2);
	background-color: rgba(0,0,0,0.8);
}

/* Restore margin for zoom control */
.leaflet-bottom.leaflet-left .leaflet-control-zoom.leaflet-control {
	margin-left: 10px;
	margin-bottom: 10px;
}

.leaflet-bottom.leaflet-left .leaflet-control-zoom.leaflet-control a {
	background-color: rgba(0,0,0,0.8);
	color: #fff;
	box-shadow: 0 0 15px rgba(255,255,255,0.2);
}


.leaflet-control-layers {
	border-radius: 0;
}

.leaflet-control-attribution.leaflet-control {
	display: none;
}

/** Header Title Styles **/
a {
  text-decoration: none;
  color: inherit;
}

.headerContainer {
	margin: 0;
	border: 0;
  	padding: 10px 25px 10px 20px;
	color: #fff;
}

#header {
  margin: 0;
  border: 0;
  padding: 0;
  color: #fff;
}

#header a {
  color: #fff;
}

#headerTitle {
  font-size: 45px;
  margin: 0 15px 0 0;
  border: 0;
  border-right: #fff 1px solid;
  padding: 0 15px 0 0;
  display: inline;
  float: left;
}

#byline {
  margin: 0;
  border: 0;
  padding: 0;
  display: inline;
  list-style-type: none;
  float: left;
}

#byline li {
  margin: 0;
  border: 0;
  padding: 0;
}

#aboutLink {
  display: none;
  float: left;
  clear: none;
  margin: 0 0 0 15px;
  border: 0;
  font-weight: bold;
  color: fff;
  cursor: pointer;
  vertical-align: middle;

  -webkit-transform: rotate(-90deg);
  -moz-transform: rotate(-90deg);
  -ms-transform: rotate(-90deg);
  -o-transform: rotate(-90deg);
  transform: rotate(-90deg);

  /* also accepts left, right, top, bottom coordinates; not required, but a good idea for styling */
  -webkit-transform-origin: 50% 50%;
  -moz-transform-origin: 50% 50%;
  -ms-transform-origin: 50% 50%;
  -o-transform-origin: 50% 50%;
  transform-origin: 50% 50%;

  /* Should be unset in IE9+ I think. */
  filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
}

#aboutLink:hover, #aboutLink:active {
  color: #ff0000;
}

.leaflet-container .header a {
  color: #fff;
}

/** About Styles **/
.leaflet-popup-content-wrapper {
	border-radius: 0;
	background: rgba(0,0,0,0.8);
	box-shadow: 0 3px 14px rgba(255,255,255,0.2);
}

.leaflet-popup-scrolled {
	border: 0;
}

.leaflet-popup-content-wrapper, .leaflet-popup-tip {
	background: rgba(0,0,0,0.8);
	box-shadow: 0 3px 14px rgba(255,255,255,0.2);
}

.leaflet-popup-tip {
	display: none;
}

.leaflet-container a.leaflet-popup-close-button {
	color: #fff;
}

.leaflet-container a.leaflet-popup-close-button:hover {
	color: #ff0000;
}

.leaflet-popup-content {
	margin-top: 30px;
}

.leaflet-popup-content p {
	margin: 0 0 15px 0;
	border: 0;
	padding: 0 19px 0 0;
}

.aHead {
  font-weight: bolder;
  display: inline;
}

#popHelp ul {
  list-style-type: none;
  margin: 0 0 15px 0;
  border: 0;
  padding: 0;
  clear: none;
}

/** Township / Grid Info Styles **/
.info {
	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	border-radius: 0;
	color: #fff;
	text-align: center;
	display: block;
	clear: both;
	margin: 0;
	border: 0;
	padding: 0;
}

.temp {
	text-transform: lowercase;
}

.bars {
	padding: 0;
	border: 0;
	margin: 0;
}

.bar.positive {
  fill: #ff0000;
}

.bar.negative {
  fill: #ff0000;
}

.x.axis path {
  fill: none;
  stroke: #fff;
  stroke-width: 1px;
}

.x.axis text {
  fill: #fff;
}

.y.axis path {
  visibility: hidden;
}

.y.axis text {
  fill: #fff;
}

/** Township / Grid View Toggle Styles **/
.leaflet-control-layers-expanded {
	background-color: #000;
	padding: 10px 10px 5px 10px;
}

input[type="radio"].layerToggle {
    display: none;
}

label.layerToggle {
    display: block;
    float: left;
    margin: 0;
    border: 0;
    padding: 4px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
    text-transform: uppercase;
}

label.layerToggle.active {
    color: #ff0000;
}

#townshipTog, #gridTog, #recenter {
  cursor: pointer;
}

#townshipTog.active, #gridTog.active {
  color: #ff0000;
}

#recenter {
  color: rgba(255,255,255,.75);
  text-align: center;
  font-weight: bold;
}

#recenter:hover {
  color: rgba(255,255,255,1);
}

#recenter:active {
  color: #ff0000;
}


/** Legend Styles **/
.legend {
  margin: 0;
  border: 0;
  padding: 10px 20px 10px 25px;
  color: #fff;
}

#legendTitle {
  margin: 0 0 5px 0;
  border: 0;
  padding: 0;
  display: block;
  clear: both;
}

#labels {
  margin: 5px 0 0 0;
  border: 0;
  padding: 0;
}

#labelLeft {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: left;
  float: left;
}

#labelRight {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: right;
  float: right;
}

</style>
</head>

<body>
<div id="map">
</div>

<script type="text/javascript" src="libs/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="libs/js/leaflet.js"></script>
<script type="text/javascript" src="libs/js/d3.v3.min.js"></script>
<script type="text/javascript" src="libs/js/simple_statistics.js"></script>

<script type="text/javascript" src="data/townships.js"></script>
<script type="text/javascript" src="data/grid.js"></script>

<script type="text/javascript">

	// Initialize map and set long, lat, and scale
	var lat = 22.65;
	var lng = 114.19;
	var scale = function() { 
		var winWidth = $(window).width();
		// return the right zoom scale for the window width
		switch (true) {
			case (winWidth > 1800): 
				return 12;
			case (winWidth > 1200):
				return 11;
			case (winWidth > 600):
				return 10;
			default: 
				return 9;
		}
	};

	var map = L.map('map', { zoomControl: false }).setView([lat, lng], scale());

	// Get basemap tiles and add to the map
	/*var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
			key: 'BC9A493B41014CAABB98F0471D759707',
			styleId: 22677
		}).addTo(map);*/

	var mapbox = L.tileLayer('http://{s}.tiles.mapbox.com/v3/erhardt.ggjdc5cf/{z}/{x}/{y}.png').addTo(map);

	// Create zoom control in specific location
	var zoom = L.control.zoom({position: "bottomleft"}).addTo(map);

	// Create a "control" that shows the map title
	var title = L.control({position: "topleft"});

	title.onAdd = function(map) {
		this._div = L.DomUtil.create('div', 'headerContainer');

		this._div.innerHTML = '<div id="header"><p id="headerTitle"><a href="/">IN THE MIX</a></p><ul id="byline"><li><a href="https://twitter.com/erhardt">Erhardt Graeff</a></li><li><a href="https://twitter.com/canadeau">Carey Anne Nadeau</a></li><li><a href="https://twitter.com/arouault">Alicia Rouault</a></li></ul><p id="aboutLink" onClick="openAbout();">about</p></div>';

		return this._div
	};

	title.addTo(map);

	// Show/Hide aboutLink in Header
	$('div.headerContainer').hover(
		function() {
			$('#aboutLink').show();
			$('#aboutLink').css("height", $('#headerTitle').height());
			$('.headerContainer').css("padding-right", "0");
			$('#byline')
				.css("border-right", "1px solid #fff")
				.css("padding", "0 15px 1px 0");
		}, function() {
			$('#aboutLink').hide();
			$('.headerContainer').css("padding-right", "10px");
			$('#byline')
				.css("border-right", "0")
				.css("padding", "0");
	});

	// Add popup with About Description to the map
	var about = L.popup( { closeOnClick: false, autoPanPaddingTopLeft: L.point(0,$(".leaflet-top.leaflet-left").outerHeight()+10), autoPanPaddingBottomRight: L.point(0, $(".leaflet-bottom.leaflet-right").outerHeight()+10), maxWidth: $(window).width()*0.75, maxHeight: $(window).height()*0.75 })
		.setLatLng(L.latLng(map.getCenter().lat-((map.getCenter().lat-map.getBounds()._southWest.lat)*.75), map.getCenter().lng))
		.setContent('<p><span class="aHead">ABOUT</span><br/>IN THE MIX visualizes data from the popular social media platform Weibo, along with 2000 Census data on four indicators representing potential innovation by township in Shenzhen, China. The premise of this index is that young, hip Weibo users can be a proxy for the location of an emergent "creative class"&mdash;characterized by diversity of workers and industries, access to cultural amenities and key infrastructure. Diverse and accessible places cultivate innovation and information spillover. Exploring 2000 Census data on what industry workers are employed in by township, we see the mix of workers that live in Shenzhen. 2013 Weibo check-ins provide a contemporary proxy for what young creatives might experience near libraries, public transportation, food and drink venues.</p><div id="popHelp"><span class="aHead">INNOVATION POTENTIAL INDEX =</span><ul><li>Emp: Diversity in Workers by Type of Industry (Census)</li><li>Food: Presence of non-local Cuisine/Diverse Amenities (Weibo)</li><li>Edu: Presence of Higher Education (Weibo)</li><li>Ind: Presence of Industrial Parks (Weibo)</li></ul></div><p>The information is represented at two scales, the first by township in a traditional choropleth map, the other as a grid overlay, showing a smaller scale look at the data per 1,000 meters square. Each township and grid square contains in-depth data on the specific make up for each location.</p><p><span class="aHead">METHOD</span><br/>In order to combine shares of different indicators (industrial parks, higher education, non-local cuisine, and diversity in workers by type of Industry) each is first standardized using the inter-decile range standardization method. This method compares each value of a variable (X<sub>i</sub>) to the median (X<sub>med</sub>), which is then divided by the distance between the value of that variable at the 90th percentile of the distribution (X<sub>90</sub>) and the 10th percentile (X<sub>10</sub>).  After each has been standardized, an average across the indicators (industrial parks, higher education, non-local cuisine, and diversity in workers by type of Industry) is calculated.</p><p>Standardized Score = 1/n * &sum; ((x<sub>i</sub> - x<sub>med</sub> ) / (x<sub>90</sub> - x<sub>10</sub>))</p><p><span class="aHead">SOURCES</span><br />2013 Weibo Data, 2000 Chinese Census Data</p><p><i>IN THE MIX is a data visualization project produced at MITâ€™s Department of Urban Studies and Planning for the forthcoming 2013 Hong Kong-Shenzhen Biennale.</i></p>');

	function openAbout() {
		about.openOn(map);
	}

	function closeAbout() {
		return null;
	}

	// Create a "control" that shows info about townships or grids on hover
	var info = L.control();
	var townScale;
	var gridScale;
	var currLayer;

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info');

		currLayer = "Township"; // default is Townships as first layer
		initScales();

		this.update();
		return this._div;
	};

	info.update = function (props) {
		var id;
		var scale;

		if ((props != null) && (currLayer == "Township")) {
			name = props.ENAME;
			id = "t" + props.GBTOWN;
			scale = townScale;
		} else if (props != null) {
			name = props.ENAME + "<br/>(Grid #" + props.PageNumber + ")";
			id = "g" + props.PageNumber;	
			scale = gridScale;		
		}

		this._div.innerHTML = (props ?
			'<div class="bars"><p><b>' + name + '</b></p><svg class="' + id + '"></svg></div>'
			: '<div><p class="temp">Hover over a ' + currLayer + '</p></div>');

		if (props != null) {
			buildBars(props, id, scale);
		}
	};

	info.addTo(map);

	// Initializing scales for township and grid indices
	function initScales() {
		// Set scale for townships based on Jenks natural breaks computed by simple_statistics.js
		townScale = d3.scale.threshold()
			.domain(ss.jenks(townships.features.map(function(d) { return +d.properties.index_town; }), 4))
			.range(d3.range(4).map(function(i) { return "q" + i + "-4"; }));

		// Set scale for grid squares based on Jenks natural breaks computed by simple_statistics.js
		gridScale = d3.scale.threshold()
			.domain(ss.jenks(grid.features.map(function(d) { return +d.properties.index_town; }), 4))
			.range(d3.range(4).map(function(i) { return "q" + i + "-4"; }));
	}

	// Create bar graphs for info on townships or grid squares
	function buildBars(d, id, scale) {

		var dataset = [d.index_emp, d.index_food, d.index_coll, d.index_ind];

	    var margin = {top: 10, right: 5, bottom: 30, left: 15},
	        w = 180 - margin.left - margin.right,
	        h = 180 - margin.top - margin.bottom;

	    var y0 = Math.max(Math.abs(d3.min(scale.domain())), Math.abs(d3.max(scale.domain())));

	    var y = d3.scale.linear()
	        .domain([-y0, y0])
	        .range([h,0])
	        .nice()

	    var x = d3.scale.ordinal()
	        .domain(d3.range(dataset.length))
	        .rangeRoundBands([0, w], .2);

	    // Prepare X Axis (shows labels)
	    var indices = ["Emp","Food","Edu","Ind"];
	    
	    var formatIndices = function(d) {
	    	return indices[d % 4];      
	    }

	    var xAxis = d3.svg.axis()
			.scale(x)
			.orient("bottom")
			.tickSize(0)
			.tickFormat(formatIndices);

	    // Prepare Y Axis (only shows 0 at x-axis)
	    var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left")
			.tickSize(0)
			.tickValues([0])
			.tickFormat(d3.format("d"));

	    // Find and instantiate svg element in popover, and set dimensions
	    var svg = d3.select("svg."+id)
			.attr("width", w + margin.left + margin.right)
			.attr("height", h + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	    // Create bar graph
	    svg.selectAll(".bar")
				.data(dataset)
			.enter().append("rect")
				.attr("class", function(d) { return d < 0 ? "bar negative" : "bar positive"; })
				.attr("y", function(d) { return y(Math.max(0, d)); })
				.attr("x", function(d, i) { return x(i); })
				.attr("height", function(d) { return Math.abs(y(d) - y(0)); })
				.attr("width", x.rangeBand());

	    // Create X Axis
		svg.append("g")
			.attr("transform","translate(0,"+y(0)+")") // offset by max height of a bar to get to the middle
			.attr("class", "x axis")
			.call(xAxis);

		svg.selectAll(".x.axis text")
			.attr("transform","translate(0,"+y(0)+")"); // offset by max height of a bar to get to bottom

	    // Create Y Axis
		svg.append("g")
			.attr("class", "y axis")
			.call(yAxis);

		// Strikethrough axis labels where values are null
		if (d.index_coll == null) {
			$(".g"+d.PageNumber+" text:contains('Edu')").css("text-decoration","line-through");
		}
		if (d.index_ind == null) {
			$(".g"+d.PageNumber+" text:contains('Ind')").css("text-decoration","line-through");
		}
		if (d.index_food == null) {
			$(".g"+d.PageNumber+" text:contains('Food')").css("text-decoration","line-through");
		}
	}

	var townshipsData;
	var gridData;

	// Colors for Grid Squares
	var GridRed = ["rgba(63,0,0,1)","rgba(127,0,0,1)","rgba(191,0,0,1)","rgba(255,0,0,1)"];

	// Set color palette for township choropleth
	var townColor = d3.scale.ordinal()
		.domain(d3.range(GridRed.length))
		.range(GridRed);

	// Township styles and functions
	function townshipsStyle(feature) {
		return {
			weight: 0.5,
			opacity: 1,
			color: 'white',
			dashArray: '1',
			fillOpacity: 0.8,
			fillColor: townColor(townScale(feature.properties.index_town)),
			className: 't'+feature.properties.GBTOWN
		};
	}

	function tHighlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 2,
			color: '#fff',
			dashArray: '',
			fillOpacity: 0.8,
		});

		if (!L.Browser.ie && !L.Browser.opera) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	function tResetHighlight(e) {
		townshipsData.resetStyle(e.target);
		info.update();
	}

	function tZoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}

	function tOnEachFeature(feature, layer) {		
		layer.on({
			mouseover: tHighlightFeature,
			mouseout: tResetHighlight,
			click: tZoomToFeature
		});
	}

	/** Grid styles and functions **/
	
	// Set color palette for grid choropleth
	var gridColor = d3.scale.ordinal()
		.domain(d3.range(GridRed.length))
		.range(GridRed);

	function gridStyle(feature) {
		return {
			weight: 0.5,
			opacity: 1,
			color: '#fff',
			dashArray: '1',
			fillOpacity: 0.8,
			fillColor: gridColor(gridScale(feature.properties.index_town))
		};
	}

	function gHighlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 2,
			color: '#fff',
			dashArray: '',
			fillOpacity: 0.8
		});

		if (!L.Browser.ie && !L.Browser.opera) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	function gResetHighlight(e) {
		gridData.resetStyle(e.target);
		info.update();
	}

	function gZoomToFeature(e) {
		console.log(e.target.getBounds());
		map.fitBounds(e.target.getBounds());
	}


	function gOnEachFeature(feature, layer) {
		layer.on({
			mouseover: gHighlightFeature,
			mouseout: gResetHighlight,
			click: gZoomToFeature
		});			
	}

	// Add GeoJSON layers for the townships and grid squares
	townshipsData = L.geoJson(townships, {
		style: townshipsStyle,
		onEachFeature: tOnEachFeature
	}).addTo(map);

	gridData = L.geoJson(grid, {
		style: gridStyle,
		onEachFeature: gOnEachFeature
	}); // don't add to map; will do automatically when toggled to

	// Create a layer control mechanism for toggling between townships and the grid
	var overlays = {
		"Townships": townshipsData,
		"Grid View": gridData
	}

	L.control.layers(overlays, null, {
		position: "topright",
		collapsed: false
	}).addTo(map);

	// Change currLayer on toggle between townships and the grid, then update info pane
	map.on('baselayerchange', function (layer, name) {
		if (layer.name == "Township") {
			currLayer = "Township";
		} else {
			currLayer = "Grid Square";
		}
		info.update();
	});

	// Convert radio buttons for layer toggle to text links
	// based on http://stackoverflow.com/a/10778686
	$('input[type="radio"], label').addClass('layerToggle');
	$('input:checked').parent().addClass('active');

	$('label').on('click', function() {
		$('label').removeClass('active');
		$(this).addClass('active');
	});

	$('label:first').after('<label class="layerToggle" style="cursor:default;margin:0 -4px"><span>::</span></label>');

	/**$('form').after('<div id="recenter" onClick="map.setView([lng, lat], scale);">(recenter map)</div>');**/

	$('div.leaflet-control-layers').append($('div.info')); // move control layers above info
	$('div.info').removeClass('leaflet-control'); // remove this class so that float style goes away and it will render in the center (forcing float:none on all screws up other controls)


	// Create the legend for the map
	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		var div = L.DomUtil.create('div', 'info legend');

		div.innerHTML = '<p id="legendTitle">INNOVATION POTENTIAL BY LOCALE</p><svg xmlns="http://www.w3.org/2000/svg" id="legendSwatches"></svg><div id="labels"><p id="labelLeft">low</p><p id="labelRight">high</p></div>';

		return div;
	};

	legend.addTo(map);

	/*** Create Legend ***/
	// Initialize the legend SVG
	var legend = d3.select("svg#legendSwatches")
		.attr("width",$("#legendTitle").width()) // fit to width of #legend div
		.attr("height", 10)
	  .append("g")
	    .attr("class", "legend");

	// Set scale for legend such that the four colors will have equal horizontal spacing
	var x = d3.scale.linear()
		.domain([0, GridRed.length-1])
		.range([0, $("#legendTitle").width()/4*3]);

	// Add color swatch rectanges
	legend.selectAll("rect")
		.data(d3.range(0, GridRed.length))
	  .enter().append("rect")
		.attr("height", $("svg#legendSwatches").height())
		.attr("x", function(d) { return x(d); })
		.attr("width", $("#legendTitle").width()/4)
		.style("fill", function(d) { return townColor(d); });

</script>
</body>
</html>