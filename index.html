<!DOCTYPE html>
<meta charset="utf-8">
<link href="libs/css/popover.css" rel="stylesheet">
<link href="libs/css/popover-override.css" rel="stylesheet">
<style>

body {
  margin: 0;
  border: 0;
  padding: 0;
  background-color: #000;
}

h1, h2, h3, p, ul, text, .popover {
  font-family: "Gill Sans","Helvetica Neue","Helvetica","Arial",sans-serif;
  font-weight: lighter;
}

a {
  text-decoration: none;
  color: inherit;
}

#container {
  margin: 0;
  border: 0;
  padding: 0;
}

#header {
  color: #fff;
  margin: 0;
  border: 0;
  padding: 10px 25px 10px 20px;
  top: 0;
  left: 0;
  position: absolute;
  background-color: #000;
}

#title {
  font-size: 45px;
  margin: 0 15px 0 0;
  border: 0;
  border-right: #fff 1px solid;
  padding: 0 15px 0 0;
  display: inline;
  float: left;
}

#byline {
  font-size: 15px;
  margin: 0;
  border: 0;
  padding: 0;
  display: inline;
  list-style-type: none;
  float: left;
}

#byline li {
  margin: 0;
  border: 0;
  padding: 0;
}

#mapContainer {
  margin: 0;
  border: 0;
  padding: 0;
}

#mapContainer svg {
    display: block;
    margin: 0 auto;
    border: 0;
    padding: 0;
}

#infoContainer {
  color: #fff;
  margin: 0;
  border: 0;
  padding: 10px 0;
}

#infoPane {
  visibility: hidden;
  width: 100%;
  text-align: center;
}

#districtinfo {
  color: #fff;
}

.background {
  fill: #000;
  pointer-events: all;
}

.gridsquare {
  stroke-width: 0.5px;
  stroke: #000;
}

.township {
  stroke: #000;
  stroke-opacity: 1;
  stroke-width: 0.5px;
  cursor: pointer;
}

.township.active {
  opacity: 0.75;
}

.township-label {
  fill: #000;
  font-size: 15px;
  font-weight: 300;
  text-anchor: middle;
  visibility: hidden;
}

.gridsquare {
  visibility: hidden;
  stroke-width: 0.5px;
  cursor: pointer;
}

.chart div {
  background-color: green;
  border: 1px white solid;
  border-left: 0;
  border-collapse: collapse;
  margin: 0;
  padding: 0;
}

.township.bar.positive {
  fill: green;
}

.township.bar.negative {
  fill: red;
}

.grid.bar.positive {
  fill: steelblue;
}

.grid.bar.negative {
  fill: red;
}

#legend {
  position: absolute;
  bottom: 0px;
  right: 0px;
  margin: 0;
  border: 0;
  padding: 10px 20px 10px 25px;
  color: #fff;
  background-color: #000;
}

#legendTitle {
  margin: 0 0 5px 0;
  border: 0;
  padding: 0;
}

#labels {
  margin: 5px 0 0 0;
  border: 0;
  padding: 0;
}

#labelLeft {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: left;
  float: left;
}

#labelRight {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: right;
  float: right;
}

</style>
<body>
<script src="libs/js/d3.v3.min.js"></script>
<script src="libs/js/colorbrewer.js"></script>
<script src="libs/js/jquery-2.0.0.min.js"></script>
<script src="libs/js/jquery.popover-1.1.2.js"></script>

<div id="container">
  <div id="header">
    <p id="title"><a href="/">IN THE MIX</a></p>
    <ul id="byline">
      <li><a href="https://twitter.com/erhardt">Erhardt Graeff</a></li>
      <li><a href="https://twitter.com/canadeau">Carey Anne Nadeau</a></li>
      <li><a href="https://twitter.com/arouault">Alicia Rouault</a></li>
    </ul>
  </div>
  <div id="mapContainer">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" id="map"></svg>
  </div>
  <div id="legend">
    <p id="legendTitle">INNOVATION POTENTIAL BY TOWNSHIP</p>
   <svg xmlns="http://www.w3.org/2000/svg" id="legendSwatches"></svg>
    <div id="labels">
      <p id="labelLeft">low</p>
      <p id="labelRight">high</p>
    </div>
  </div>
</div>

<script>

// Set height of map-space according to width of window
function setHeight() {
  $("#map").height($(window).height());
  return $("#map").height();
}

// Set data sources
var waterboundaries = "data/waterboundary.json";
var townships = "data/Index_Township.json";
var grids = "data/Index_Grid1000.json";

// Set main map svg element 
var map = d3.select("svg");

// Set dimensions of the map based on map element dimensions
var width = $("#map").width();
var height = setHeight(); // sets height of map based on window height and then stores to deal with Firefox var set / function call ordering
var centered;

// Set projection of map to Mercator and center over Shenzhen
var projection = d3.geo.mercator()
  .center([114.1333,22.6333])
    .scale(65000)
    .translate([width / 2, height / 2]);

// Set all path elements to conform to the selected projection
var path = d3.geo.path()
    .projection(projection);

// Add path groups to map in order to ensure layering bottom to top
var gw = map.append("g").attr("id","waterboundaries");
var gt = map.append("g").attr("id","townships");
var gg = map.append("g").attr("id","grids");

// Add waterboundary polygon
d3.json(waterboundaries, function(error, wb) {
  gw.selectAll(".waterboundary")
    .data(wb.features)
    .enter().append("path")
      .attr("class","waterboundary")
      .attr("d", path)
      .attr("fill", "#1C6BA0")
      .on("click", clicked);
});

// Set color palette for township choropleth
var townColor = d3.scale.ordinal()
  .domain(d3.range(4))
  .range(colorbrewer.Reds[4]);

// Quantize town indices into quintiles
var townQuantile = d3.scale.quantile()
    .domain([-0.338590,0.534757]) // Min/Max Grabbed by hand, sorting in QGIS
    .range(d3.range(4));

// Set color palette for grid choropleth
var gridColor = d3.scale.ordinal()
  .domain(d3.range(5))
  .range(colorbrewer.Reds[5]);

// Quantize grid square indices into quintiles
var gridQuantile = d3.scale.quantile()
    .domain([-0.252467,3.463016]) // Min/Max Grabbed by hand, sorting in QGIS
    .range(d3.range(5));

// Add township polygons
d3.json(townships, function(error, sz) {
	
  var dataset = sz.features;

  gt.selectAll(".township")
  	  .data(dataset)
    .enter().append("path")
    	.attr("class", function(d) { return "township " + "t" + d.properties.GBTOWN; })
    	.attr("d", path)
      // colors for categories
      .attr("fill", function(d) { return townColor(townQuantile(d.properties.index_town)); })
      // mouseover changes township fill and shows label
    	.on("mouseover", function(d) { addPopover(this,d); }

        /*function(d) {
        d3.select(this).style("opacity", "0.75");
    		d3.selectAll(".township-label.t" + sz.features.indexOf(d)).style("visibility","visible");
        d3.select(this).call(addPopover(this,d));
    	}*/)
    	.on("mouseout", function(d) {
        d3.selectAll(".township").style("opacity","1");
        d3.selectAll(".township.active").style("opacity","0.75"); // keeps active township orange
    	})
      .on("click", clicked);
});

// Add grid square polygons
d3.json(grids, function(error, gs) {

  var dataset = gs.features;

  gg.selectAll(".gridsquare")
      .data(dataset)
    .enter().append("path")
      .attr("class", function(d) { return "gridsquare g"+d.properties.PageNumber; })
      .attr("d", path)
      .attr("fill", function(d) { return gridColor(gridQuantile(d.properties.index_grid)); })
      .on("click", clicked);

  /*addTownPopovers();*/
});

/* Click and zoom to townships 
    (based on http://bl.ocks.org/mbostock/2206590) */
function clicked(d) {
  var x, y, k;

  if (d.text != null) {
    d = d3.selectAll(".township.t" + d.properties.GBTOWN);
  }

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 3;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  gt.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gw.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gg.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  gt.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gw.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gg.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");

  if (d && centered !== d) {
    hideInfo(d);
  } else {
    showInfo(d);
  }
}

// Show information pane below map
function showInfo(d) {
/*  ip = document.getElementById('infoPane');
  ip.style.visibility = "visible";
  document.getElementById('townshipinfo').innerHTML = d.properties.ENAME;*/

  // Make grid squares visible
  gg.selectAll("path").style("visibility","visible");

  return;
}

// Hide information pane below map
function hideInfo(d) {
/*  ip = document.getElementById('infoPane');
  ip.style.visibility = "hidden";*/

  // Make grid squares invisible
  gg.selectAll("path").style("visibility","hidden");

  return;
}

// Adds popovers for displaying detailed information of townships
function addPopover(el,d) {

  d3.select(el).style("opacity", "0.75");

  if ($(el).popover('getData') != null) {
   /* $(el).popover('destroy');   // delete existing popovers*/
  } else { 
    $(el).popover({
      'title': d.properties.ENAME,
      'html': true,
      'classes': d.properties.GBTOWN,
      'content': '<svg class="t'+d.properties.GBTOWN+'"></svg>',
      'position': 'left',
      'trigger': 'hover',
      'animation': false 
    });

    var dataset = [d.properties.index_emp,d.properties.index_food, d.properties.index_coll, d.properties.index_ind];

    var margin = {top: 10, right: 5, bottom: 5, left: 10},
        w = 180 - margin.left - margin.right,
        h = 180 - margin.top - margin.bottom;

    var y0 = Math.max(Math.abs(d3.min(dataset)), Math.abs(d3.max(dataset)));

    var y = d3.scale.linear()
        .domain([-y0, y0])
        .range([h,0])
        .nice();

    var x = d3.scale.ordinal()
        .domain(d3.range(dataset.length))
        /*.range(["Food","College","Industry"])*/
        .rangeRoundBands([0, w], .2);

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var svg = d3.select("svg.t"+d.properties.GBTOWN)
        .attr("width", w + margin.left + margin.right)
        .attr("height", h + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.selectAll(".bar")
        .data(dataset)
      .enter().append("rect")
        .attr("class", function(d) { return d < 0 ? "township bar negative" : "township bar positive"; })
        .attr("y", function(d) { return y(Math.max(0, d)); })
        .attr("x", function(d, i) { return x(i); })
        .attr("height", function(d) { return Math.abs(y(d) - y(0)); })
        .attr("width", x.rangeBand());

    svg.append("g")
        .attr("class", "x axis")
        .call(yAxis);

    svg.append("g")
        .attr("class", "y axis")
      .append("line")
        .attr("y1", y(0))
        .attr("y2", y(0))
        .attr("x1", 0)
        .attr("x2", w);
  }
}

// Adds popovers for displaying detailed information of townships
function addTownPopovers() {

  // Loop through all townships and add popovers to them
  d3.json(townships, function(error, sz) {

    var dd = sz.features;

    for(var j = 0; j < dd.length; j++) {
      if ($('.township.t'+j).popover('getData') != null) {
        $('.township.t'+j).popover('destroy');   // delete existing popovers
      } else { 
        $('.township.t'+j).popover({
          'title': dd[j].properties.ENAME,
          'html': true,
          'classes': '.t'+j,
          'content': '<svg class="t'+j+'"></svg>',
          'position': 'left',
          'trigger': 'hover',
          'animation': false
        });

        var dataset = [dd[j].properties.Index_to_3, dd[j].properties.Index_to_4, dd[j].properties.Index_to_5];

        var margin = {top: 10, right: 5, bottom: 5, left: 10},
            w = 180 - margin.left - margin.right,
            h = 180 - margin.top - margin.bottom;

        var y0 = Math.max(Math.abs(d3.min(dataset)), Math.abs(d3.max(dataset)));

        var y = d3.scale.linear()
            .domain([-y0, y0])
            .range([h,0])
            .nice();

        var x = d3.scale.ordinal()
            .domain(d3.range(dataset.length))
            /*.range(["Food","College","Industry"])*/
            .rangeRoundBands([0, w], .2);

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var svg = d3.select("svg.t"+j)
            .attr("width", w + margin.left + margin.right)
            .attr("height", h + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.selectAll(".bar")
            .data(dataset)
          .enter().append("rect")
            .attr("class", function(d) { return d < 0 ? "township bar negative" : "township bar positive"; })
            .attr("y", function(d) { return y(Math.max(0, d)); })
            .attr("x", function(d, i) { return x(i); })
            .attr("height", function(d) { return Math.abs(y(d) - y(0)); })
            .attr("width", x.rangeBand());

        svg.append("g")
            .attr("class", "x axis")
            .call(yAxis);

        svg.append("g")
            .attr("class", "y axis")
          .append("line")
            .attr("y1", y(0))
            .attr("y2", y(0))
            .attr("x1", 0)
            .attr("x2", w);
      }
    }
  });

  /*addGridPopovers();*/
}

// Adds popovers for displaying detailed information of gridsquares
function addGridPopovers() {

  // Loop through all townships and add popovers to them
  d3.json(grids, function(error, gs) {

    var dd = gs.features;

    for(var j = 0; j < dd.length; j++) {
      if ($('.gridsquare.g'+j).popover('getData') != null) {
        $('.gridsquare.g'+j).popover('destroy');   // delete existing popovers
      } else { 
        $('.gridsquare.g'+j).popover({
          'title': dd[j].properties.ename + ": " + dd[j].properties.PageName,
          'html': true,
          'classes': '.g'+j,
          'content': '<svg class="g'+j+'"></svg>',
          'position': 'left',
          'trigger': 'hover',
          'animation': false
        });

        var dataset = [dd[j].properties.index_food, dd[j].properties.index_coll, dd[j].properties.index_ind];

        var margin = {top: 10, right: 5, bottom: 5, left: 10},
            w = 180 - margin.left - margin.right,
            h = 180 - margin.top - margin.bottom;

        var y0 = Math.max(Math.abs(d3.min(dataset)), Math.abs(d3.max(dataset)));

        var y = d3.scale.linear()
            .domain([-y0, y0])
            .range([h,0])
            .nice();

        var x = d3.scale.ordinal()
            .domain(d3.range(dataset.length))
           /* .range(["Food","College","Industry"])*/
            .rangeRoundBands([0, w], .2);

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var svg = d3.select("svg.g"+j)
            .attr("width", w + margin.left + margin.right)
            .attr("height", h + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.selectAll(".bar")
            .data(dataset)
          .enter().append("rect")
            .attr("class", function(d) { return d < 0 ? "grid bar negative" : "grid bar positive"; })
            .attr("y", function(d) { return y(Math.max(0, d)); })
            .attr("x", function(d, i) { return x(i); })
            .attr("height", function(d) { return Math.abs(y(d) - y(0)); })
            .attr("width", x.rangeBand());

        svg.append("g")
            .attr("class", "x axis")
            .call(yAxis);

        svg.append("g")
            .attr("class", "y axis")
          .append("line")
            .attr("y1", y(0))
            .attr("y2", y(0))
            .attr("x1", 0)
            .attr("x2", w);
      }
    }
  });
}

//Add legend for choropleths
var legend = d3.select("svg#legendSwatches")
    .attr("width",$("#legendTitle").width())
    .attr("height", 10)
  .append("g")
    .attr("class", "legend");

var x = d3.scale.linear()
    .domain([0, 3])
    .range([0, $("#legendTitle").width()/4*3]);

legend.selectAll("rect")
    .data([0,1,2,3])
  .enter().append("rect")
    .attr("height", $("svg#legendSwatches").height())
    .attr("x", function(d) { return x(d); })
    .attr("width", $("#legendTitle").width()/4)
    .style("fill", function(d) { return townColor(d); });

</script>