<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue","Helvetica","Arial",sans-serif;
}

#infopane {
  visibility: hidden;
  width: 1160px;
  text-align: center;
}

#districtinfo {
  color: #fff;
}

.background {
  fill: none;
  pointer-events: all;
}

.township {
  stroke: #000;
  stroke-opacity: 1;
}

.township.active {
  fill: #fff;
  stroke: #000;
}

.township-label {
  fill: #333;
  fill-opacity: .75;
  font-size: 15px;
  font-weight: 300;
  text-anchor: middle;
  visibility: hidden;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 1160,
    height = 600,
    centered;

var projection = d3.geo.mercator()
	.center([114.1333,22.6333])
    .scale(65000)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var color = d3.scale.category10();

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

var g = svg.append("g");

d3.json("townships.json", function(error, sz) {
	console.log(sz);
  	g.selectAll("path")
    	.data(sz.features)
      .enter().append("path")
    	.attr("class", function(d) { return "township " + "t" + sz.features.indexOf(d); })
    	.attr("d", path)
      // colors for categories
      .attr("fill", function(d) { return color(d.properties.ENAME3); })
      // mouseover changes township fill and shows label
    	.on("mouseover", function(d) {
        d3.select(this).style({'fill':'#fff'});
    		d3.selectAll(".township-label.t" + sz.features.indexOf(d)).style("visibility","visible");
    	})
    	.on("mouseout", function(d) {
        d3.selectAll(".township").style({'fill': function (d) { return color(d.properties.ENAME3)}});
        d3.selectAll(".township-label").style("visibility","hidden");
        d3.selectAll(".township.active").style({'fill':'#fff'}); // keeps active township white
    	})
      .on("click", clicked);

	g.selectAll(".township-label")
	    .data(sz.features)
	  .enter().append("text")
	    .attr("class", function(d) { return "township-label " + "t" + sz.features.indexOf(d); })
	    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
	    .attr("dy", ".35em")
      // preserves highlighting of township even when over top of label
	    .on("mousemove", function(d) {
    		d3.selectAll(".township-label.t" + sz.features.indexOf(d)).style("visibility","visible");
    		d3.selectAll(".township.t" + sz.features.indexOf(d)).style({'fill':'#fff'});
    	})
	    .text(function(d) { return d.properties.ENAME; })
      .on("click", clicked);
  });

/* Click and zoom function based on http://bl.ocks.org/mbostock/2206590 */
function clicked(d) {
  var x, y, k;

  if (d.text != null) {
    d = d3.selectAll(".township.t" + sz.features.indexOf(d));
  }

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 3;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

  if (d && centered !== d) {
    hideInfo(d);
  } else {
    showInfo(d);
  }
}

function showInfo(d) {
  ip = document.getElementById('infopane');
  ip.style.visibility = "visible";
  document.getElementById('townshipinfo').innerHTML = d.properties.ENAME;

  di = document.getElementById('districtinfo');
  di.innerHTML = d.properties.ENAME3;
  di.style.background = color(d.properties.ENAME3);
  return;
}

function hideInfo(d) {
  ip = document.getElementById('infopane');
  ip.style.visibility = "hidden";
  return;
}


</script>
<div id="infopane">
  <h3>Information</h3>
  <p>Township: <span id="townshipinfo">null</span></p>
  <p>District: <span id="districtinfo">null</span></p>
</div>