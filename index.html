<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  margin: 0;
  border: 0;
  padding: 0;
  background-color: #000;
}

h1, h2, h3, p, text {
  font-family: "Gill Sans","Helvetica Neue","Helvetica","Arial",sans-serif;
  font-weight: lighter;
}

#container {
  margin: 0;
  border: 0;
  padding: 0;
}

#header {
  color: #fff;
  margin: 0;
  border: 0;
  padding: 10px 0 20px 20px;
}

#title {
  font-size: 50px;
  margin: 0;
  border: 0;
  padding: 0;
}

#byline {
  font-size: 20px;
  margin: 0;
  border: 0;
  padding: 0;
}

#mapContainer {
  margin: 0;
  border: 0;
  padding: 0;
}

#mapContainer svg {
    display: block;
    margin: 0 auto;
    border: 0;
    padding: 0;
}

#infoContainer {
  color: #fff;
  margin: 0;
  border: 0;
  padding: 10px 0;
}

#infoPane {
  visibility: hidden;
  width: 100%;
  text-align: center;
}

#districtinfo {
  color: #fff;
}

.background {
  fill: #000;
  pointer-events: all;
}

.township {
  stroke: #000;
  stroke-opacity: 1;
  stroke-width: 0.75px;
}

.township.active {
  fill: orange;
  stroke: #000;
  stroke-width: 2px;
  stroke-opacity: 1;
}

.township-label {
  fill: #000;
  font-size: 15px;
  font-weight: 300;
  text-anchor: middle;
  visibility: hidden;
}

.gridsquare {
  visibility: hidden;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="libs/colorbrewer.js"></script>

<div id="container">
  <div id="header">
    <p id="title">Shenzhen Creative Index</p>
    <p id="byline">by Erhardt Graeff, Carey Anne Nadeau, Alicia Rouault</p>
  </div>
  <div id="mapContainer">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="600" id="map"></svg>
  </div>
  <div id="infoContainer">
    <div id="infoPane">
      <h3>Information</h3>
      <p>Township: <span id="townshipinfo">null</span></p>
    </div>    
  </div>
</div>

<script>

/* Set color palette for township choropleth, 
    offset +1 to remove near-white color (see +1 near fill attr) */
var townColor = d3.scale.ordinal()
  .domain([0,5])
  .range(colorbrewer.Greens[6]);

/* Set color palette for grid choropleth, 
    offset +1 to remove near-white color (see +1 near fill attr) */
var gridColor = d3.scale.ordinal()
  .domain([0,5])
  .range(colorbrewer.Oranges[6]);

// Quantize town and grid square indices into quartiles
var townQuantize = d3.scale.quantize()
    .domain([0, 9])
    .range(d3.range(4));

var gridQuantize = d3.scale.quantize()
    .domain([418, 4664])
    .range(d3.range(4));

// Set main map svg element 
var map = d3.select("svg");

// Set dimensions of the map based on map element dimensions
var width = getWidth();
var height = map.attr("height");
var centered;

// Set projection of map to Mercator and center over Shenzhen
var projection = d3.geo.mercator()
  .center([114.1333,22.6333])
    .scale(65000)
    .translate([width / 2, height / 2]);

// Set all path elements to conform to the selected projection
var path = d3.geo.path()
    .projection(projection);

// Add path groups to map in order to ensure layering bottom to top
var gw = map.append("g").attr("id","waterboundaries");
var gt = map.append("g").attr("id","townships");
var gg = map.append("g").attr("id","grids");

// Add waterboundary polygon
d3.json("data/waterboundary.json", function(error, wb) {
  gw.selectAll(".waterboundary")
    .data(wb.features)
    .enter().append("path")
      .attr("class","waterboundary")
      .attr("d", path)
      .attr("fill", "#1C6BA0")
      .on("click", clicked);
});

// Add township polygons
d3.json("data/townships.json", function(error, sz) {
	gt.selectAll(".township")
  	.data(sz.features)
    .enter().append("path")
    	.attr("class", function(d) { return "township " + "t" + sz.features.indexOf(d); })
    	.attr("d", path)
      // colors for categories
      .attr("fill", function(d) { return townColor(townQuantize(d.properties.Input_FID)+1); })
      // mouseover changes township fill and shows label
    	.on("mouseover", function(d) {
        d3.select(this).attr("fill", "orange");
    		d3.selectAll(".township-label.t" + sz.features.indexOf(d)).style("visibility","visible");
    	})
    	.on("mouseout", function(d) {
        d3.selectAll(".township").attr("fill", function (d) { return townColor(townQuantize(d.properties.Input_FID)+1); });
        d3.selectAll(".township-label").style("visibility","hidden");
        d3.selectAll(".township.active").attr("fill","orange"); // keeps active township orange
    	})
      .on("click", clicked);

  // Add township labels
	gt.selectAll(".township-label")
	    .data(sz.features)
	  .enter().append("text")
	    .attr("class", function(d) { return "township-label " + "t" + sz.features.indexOf(d); })
	    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
	    .attr("dy", ".35em")
      // preserves highlighting of township even when over top of label
	    .on("mousemove", function(d) {
    		d3.selectAll(".township-label.t" + sz.features.indexOf(d)).style("visibility","visible");
    		d3.selectAll(".township.t" + sz.features.indexOf(d)).attr("fill", "orange");
    	})
	    .text(function(d) { return d.properties.ENAME; })
      .on("click", clicked);
});

// Add grid square polygons
d3.json("data/luohu.json", function(error, gs) {
  gg.selectAll(".gridsquare")
    .data(gs.features)
    .enter().append("path")
      .attr("class","gridsquare")
      .attr("d", path)
      .attr("fill", function(d) { return gridColor(gridQuantize(d.properties.PageNumber)+1); })
      .on("click", clicked);
});

/* Click and zoom to townships 
    (based on http://bl.ocks.org/mbostock/2206590) */
function clicked(d) {
  var x, y, k;

  if (d.text != null) {
    d = d3.selectAll(".township.t" + sz.features.indexOf(d));
  }

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 3;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  gt.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gw.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gg.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  gt.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gw.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gg.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");

  if (d && centered !== d) {
    hideInfo(d);
  } else {
    showInfo(d);
  }
}

// Show information pane below map
function showInfo(d) {
  ip = document.getElementById('infoPane');
  ip.style.visibility = "visible";
  document.getElementById('townshipinfo').innerHTML = d.properties.ENAME;

  // Make grid squares visible
  gg.selectAll("path").style("visibility","visible");

  return;
}

// Hide information pane below map
function hideInfo(d) {
  ip = document.getElementById('infoPane');
  ip.style.visibility = "hidden";

  // Make grid squares invisible
  gg.selectAll("path").style("visibility","hidden");

  return;
}

// Determines page width
function getWidth() {
  return parseInt(window.innerWidth);
}

</script>