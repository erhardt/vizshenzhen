<!DOCTYPE html>
<meta charset="utf-8">
<link href="libs/css/popover.css" rel="stylesheet">
<link href="libs/css/popover-override.css" rel="stylesheet">
<style>

/* Elements */
body {
  margin: 0;
  border: 0;
  padding: 0;
  background-color: #000;
}

h1, h2, h3, p, ul, text, div {
  font-family: "Gill Sans","Helvetica Neue","Helvetica","Arial",sans-serif;
  font-weight: lighter;
}

a {
  text-decoration: none;
  color: inherit;
}

/* IDs */
#container {
  margin: 0;
  border: 0;
  padding: 0;
}

#header {
  color: #fff;
  margin: 0;
  border: 0;
  padding: 10px 25px 10px 20px;
  top: 0;
  left: 0;
  position: absolute;
  background-color: #000;
}

#headerTitle {
  font-size: 45px;
  margin: 0 15px 0 0;
  border: 0;
  border-right: #fff 1px solid;
  padding: 0 15px 0 0;
  display: inline;
  float: left;
}

#byline {
  font-size: 15px;
  margin: 0;
  border: 0;
  padding: 0;
  display: inline;
  list-style-type: none;
  float: left;
}

#byline li {
  margin: 0;
  border: 0;
  padding: 0;
}

#mapToggle {
  position: absolute;
  top: 0;
  right: 0;
  margin: 0;
  border: 0;
  padding: 10px 20px 10px 25px;
  color: #fff;
  background-color: #000;
  font-weight: bold;
}

#townshipTog, #gridTog {
  cursor: pointer;
}

#townshipTog.active, #gridTog.active {
  color: #ff0000;
}

#mapContainer {
  margin: 0;
  border: 0;
  padding: 0;
}

#mapContainer svg {
    display: block;
    margin: 0 auto;
    border: 0;
    padding: 0;
}

#legend {
  position: absolute;
  bottom: 0px;
  right: 0px;
  margin: 0;
  border: 0;
  padding: 10px 20px 10px 25px;
  color: #fff;
  background-color: #000;
}

#legendTitle {
  margin: 0 0 5px 0;
  border: 0;
  padding: 0;
}

#labels {
  margin: 5px 0 0 0;
  border: 0;
  padding: 0;
}

#labelLeft {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: left;
  float: left;
}

#labelRight {
  padding: 0;
  border: 0;
  margin: 0;
  text-align: right;
  float: right;
}

#about {
  position: absolute;
  top: 50px;
  left: 200px;
  margin: 0;
  border: 0;
  padding: 10px 20px 5px;
  color: #fff;
  background-color: rgba(0,0,0,0.85);
  font-size: 20px;
}

#about p {
  margin: 15px 0;
  border: 0;
  padding: 0;
}

#aboutTitle {
  display: inline;
  float: left;
}

#aboutClose {
  display: inline;
  float: right;
}

#closer {
  cursor: pointer;
}

#closer:hover {
  color: #ff0000;
}

#aboutDescription {
  display: block;
  clear: left;
}

.background {
  fill: #000;
  pointer-events: all;
}

.bar.positive {
  fill: green;
}

.bar.negative {
  fill: red;
}

/* Classes */
.gridsquare {
  stroke-width: 0px;
  stroke: #000;
  visibility: hidden;
  cursor: pointer;
}

.township {
  stroke: #000;
  stroke-opacity: 1;
  stroke-width: 0px;
  cursor: pointer;
}

.township.active {
  opacity: 0.85;
}

.township-label {
  fill: #000;
  font-size: 15px;
  font-weight: 300;
  text-anchor: middle;
  visibility: hidden;
}

.waterboundary {
  fill: #808080;
}

</style>
<body>
<script src="libs/js/d3.v3.min.js"></script>
<script src="libs/js/colorbrewer.js"></script>
<script src="libs/js/jquery-2.0.0.min.js"></script>
<script src="libs/js/jquery.popover-1.1.2.js"></script>

<div id="container">
  <div id="header">
    <p id="headerTitle"><a href="/">IN THE MIX</a></p>
    <ul id="byline">
      <li><a href="https://twitter.com/erhardt">Erhardt Graeff</a></li>
      <li><a href="https://twitter.com/canadeau">Carey Anne Nadeau</a></li>
      <li><a href="https://twitter.com/arouault">Alicia Rouault</a></li>
    </ul>
  </div>
  <div id="mapToggle">
    <p id="toggleButtons"><span id="townshipTog" class="active" onClick="hideGrids()">TOWNSHIPS</span>&nbsp;::&nbsp;<span id="gridTog" onClick="showGrids();">GRID VIEW</span>
  </div>
  <div id="mapContainer">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" id="map"></svg>
  </div>
  <div id="legend">
    <p id="legendTitle">INNOVATION POTENTIAL BY LOCALE</p>
   <svg xmlns="http://www.w3.org/2000/svg" id="legendSwatches"></svg>
    <div id="labels">
      <p id="labelLeft">low</p>
      <p id="labelRight">high</p>
    </div>
  </div>
  <div id="about">
    <div id="aboutTitle"><p>ABOUT</p></div><div id="aboutClose"><p onClick="closeAbout()" id="closer">X</p></div>
    <div id="aboutDescription">
      <p>Understanding that young, hip Weibo users may be a proxy for a Chinese creative class, we aim to characterize areas by their diversity of workers, across many industries, and access to cultural amenities and key infrastructure. We believe more diverse and accessible places are prime for innovation and information spillover. So where are these places? We start by looking at data from the 2000 census for workers employed by industry. This grounds our study in what may be a historical entrenchment of industry location and mix by township. Weibo check-in data from 2013 gives us contemporary proxies for what a young creative class might experience and where through proximity to libraries, public transportation stops, and food and drink venues. We spotlight the northwest district of Bao’an and core district of Luohu to contrast these mixes of industry and lifestyle.</p>
      <p>In order to combine shares of different indicators, each is standardized using the inter-decile range standardization method. This method compares each value of a variable (X<sub>i</sub>) to the median (X<sub>med</sub>), which is then divided by the distance between the value of that variable at the 90th percentile of the distribution (X<sub>90</sub>) and the 10th percentile (X<sub>10</sub>):  This method was judged more appropriate for these data than Z-score standardization, which compares each value of a variable to the mean and divides their difference by the standard deviation, as the values are not likely to follow a normal distribution. It was also preferred to range standardization (which compares each value of a variable to the minimum and divides their residual by the distance between the minimum and the maximum) because of the sensitivity of this latter method to outliers. Inter-decile range standardization helps to minimize the influence of outliers by using the 90th and the 10th percentile values instead of the minimum and maximum values, and best reflects the non-normal distribution of the different indicators.</p>
      <p>Standardized Score = &sum;((x<sub>i</sub> -x<sub>med</sub> )/ (x<sub>90</sub> – x<sub>10</sub>))</p>
    </div>
  </div>
</div>

<script>

/*** Instantiate Global Variables ***/
// Set data sources
var waterboundaries = "data/waterboundary.json";
var townships = "data/Index_Township.json";
var grids = "data/Index_Grid.json";

// Set main map svg element 
var map = d3.select("svg");

// Set dimensions of the map based on map element dimensions
var width = $("#map").width();
var height = setHeight(); // sets height of map based on window height and then stores to deal with Firefox var set / function call ordering
var centered;

// Set projection of map to Mercator and center over Shenzhen
var projection = d3.geo.mercator()
  .center([114.1333,22.6333])
    .scale(65000)
    .translate([width / 2, height / 2]);

// Set all path elements to conform to the selected projection
var path = d3.geo.path()
    .projection(projection);

// Add path groups to map in order to ensure layering bottom to top
var gw = map.append("g").attr("id","waterboundaries");
var gt = map.append("g").attr("id","townships");
var gg = map.append("g").attr("id","grids");

// Set color palette for township choropleth
var townColor = d3.scale.ordinal()
  .domain(d3.range(4))
  .range(colorbrewer.Reds[4]);

// Quantize town indices into quintiles
var townQuantile = d3.scale.quantile()
    .domain([-0.338590,0.534757]) // Min/Max Grabbed by hand, sorting in QGIS
    .range(d3.range(4));

// Set color palette for grid choropleth
var gridColor = d3.scale.ordinal()
  .domain(d3.range(4))
  .range(colorbrewer.Reds[4]);

// Quantize grid square indices into quintiles
var gridQuantile = d3.scale.quantile()
    .domain([-0.252467,3.463016]) // Min/Max Grabbed by hand, sorting in QGIS
    .range(d3.range(4));


/*** Render Geography ***/
// Add waterboundary polygon
d3.json(waterboundaries, function(error, wb) {
  gw.selectAll(".waterboundary")
    .data(wb.features)
    .enter().append("path")
      .attr("class","waterboundary")
      .attr("d", path)
      .on("click", function(d) { clicked(this, d); });
});

// Add township polygons
d3.json(townships, function(error, sz) {
  gt.selectAll(".township")
  	  .data(sz.features)
    .enter().append("path")
    	.attr("class", function(d) { return "township " + "t" + d.properties.GBTOWN; })
    	.attr("d", path)
      // colors for categories
      .attr("fill", function(d) { return townColor(townQuantile(d.properties.index_town)); })
      // mouseover changes township fill and shows popover
    	.on("mouseover", function(d) { 
        d3.select(this).style("opacity","0.75");
        addPopover(this,d); })
    	.on("mouseout", function(d) {
        d3.selectAll(".township").style("opacity","1");
        d3.selectAll(".township.active").style("opacity","0.75"); // keeps active township
    	})
      .on("click", function(d) { clicked(this, d); });
});

// Add grid square polygons
d3.json(grids, function(error, gs) {
  gg.selectAll(".gridsquare")
      .data(gs.features)
    .enter().append("path")
      .attr("class", function(d) { return "gridsquare g"+d.properties.PageNumber; })
      .attr("d", path)
      .attr("fill", function(d) { return gridColor(gridQuantile(d.properties.index_town)); })
      // mouseover changes gridsquare fill and shows popover
      .on("mouseover", function(d) { 
        d3.select(this).style("opacity","0.85");
        addPopover(this,d); })
      .on("mouseout", function(d) {
        d3.select(this).style("opacity","1");
        d3.selectAll(".gridsquare.active").style("opacity","0.85"); // keeps active township
      })
      .on("click", function(d) { clicked(this, d); });
});


/*** Create Legend ***/
// Initialize the legend SVG
var legend = d3.select("svg#legendSwatches")
    .attr("width",$("#legendTitle").width()) // fit to width of #legend div
    .attr("height", 10)
  .append("g")
    .attr("class", "legend");

/// Set scale for legend such that the four colors will have equal horizontal spacing
var x = d3.scale.linear()
    .domain([0, 3])
    .range([0, $("#legendTitle").width()/4*3]);

// Add color swatch rectanges
legend.selectAll("rect")
    .data([0,1,2,3])
  .enter().append("rect")
    .attr("height", $("svg#legendSwatches").height())
    .attr("x", function(d) { return x(d); })
    .attr("width", $("#legendTitle").width()/4)
    .style("fill", function(d) { return townColor(d); });


/*** Feature Functions ***/
// Adds popovers for displaying detailed information of townships
function addPopover(el,d) {

  // Make active polygon opaque
  d3.select(el).style("opacity", "0.75");

  // Check if it's a township or gridsquare and set appropriate variables
  var id = "";
  var name = "";

  if (d3.select(el).classed("township")) {
    id = "t" + d.properties.GBTOWN;
    name = d.properties.ENAME;
  } else {
    id = "g" + d.properties.PageNumber;
    name = "Grid #" + d.properties.PageNumber;
  }

  // Create popover
  if ($(el).popover('getData') != null) {
    /*$(el).popover('destroy');   // delete existing popovers*/
  } else { 
    $(el).popover({
      'title': name,
      'html': true,
      'classes': id,
      'content': '<svg class="'+id+'"></svg>',
      'position': 'left',
      'trigger': 'hover',
      'animation': false 
    });

    var dataset = [d.properties.index_emp,d.properties.index_food, d.properties.index_coll, d.properties.index_ind];

    var margin = {top: 10, right: 5, bottom: 5, left: 10},
        w = 180 - margin.left - margin.right,
        h = 180 - margin.top - margin.bottom;

    var y0 = Math.max(Math.abs(d3.min(dataset)), Math.abs(d3.max(dataset)));

    var y = d3.scale.linear()
        .domain([-y0, y0])
        .range([h,0])
        .nice();

    var x = d3.scale.ordinal()
        .domain(d3.range(dataset.length))
        /*.range(["Food","College","Industry"])*/
        .rangeRoundBands([0, w], .2);

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var svg = d3.select("svg."+id)
        .attr("width", w + margin.left + margin.right)
        .attr("height", h + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.selectAll(".bar")
        .data(dataset)
      .enter().append("rect")
        .attr("class", function(d) { return d < 0 ? "bar negative" : "bar positive"; })
        .attr("y", function(d) { return y(Math.max(0, d)); })
        .attr("x", function(d, i) { return x(i); })
        .attr("height", function(d) { return Math.abs(y(d) - y(0)); })
        .attr("width", x.rangeBand());

    svg.append("g")
        .attr("class", "x axis")
        .call(yAxis);

    svg.append("g")
        .attr("class", "y axis")
      .append("line")
        .attr("y1", y(0))
        .attr("y2", y(0))
        .attr("x1", 0)
        .attr("x2", w);
  }
}

/* Click and zoom to townships 
    (based on http://bl.ocks.org/mbostock/2206590) */
function clicked(el, d) {
  var x, y, k;

  if ((d && centered !== d) && !(d3.select(el).classed("waterboundary"))) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 3;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  gt.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gw.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });
  gg.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  gt.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gw.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
  gg.transition()
    .duration(750)
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
    .style("stroke-width", 1.5 / k + "px");
}

// Set height of map-space according to height of window
function setHeight() {
  $("#map").height($(window).height());
  return $("#map").height();
}

// Show Grid Squares
function showGrids(d) {

  // Switch active class between toggle links
  $("#townshipTog").removeClass("active");
  $("#gridTog").addClass("active");

  // Change color of Townships to Greys
  townColor.range(colorbrewer.Greys[4]);

  gt.selectAll("path").transition().delay(0)
    .attr("fill", function(d) { return townColor(townQuantile(d.properties.index_town)); })

  // Make grid squares visible
  gg.selectAll("path").style("visibility","visible");

  return;
}

// Hide Grid Squares
function hideGrids(d) {

  // Switch active class between toggle links
  $("#gridTog").removeClass("active");
  $("#townshipTog").addClass("active");

  // Change color of Townships back to reds
  townColor.range(colorbrewer.Reds[4]);

  gt.selectAll("path").transition().delay(0)
    .attr("fill", function(d) { return townColor(townQuantile(d.properties.index_town)); })

  // Make grid squares invisible
  gg.selectAll("path").style("visibility","hidden");
  
  return;
}

// Close the about popup
function closeAbout() {
  $("#about").css("visibility","hidden");
}

// Style about box according to dimensions of window
$(document).ready(function() {
  $("#about").width($(document).width()/100*75);
  $("#about").css("top",$(document).height()/2-$("#about").height()/2);
  $("#about").css("left",$(document).width()/2-$("#about").width()/2);
});

</script>